#include <stdio.h>
#include<windows.h>
#include<conio.h>
#include<string.h>
#include<time.h>
// khai bao mot so bien su dung cho chuong trinh
int character[1000];//bien con ran,1xxyy,khai bao bien toa do 2so ve 1so R->R2
int length = 2;//bien chieu dai
int fruit;//bien moi con ran
int score;// bien diem
clock_t t;
int s_e;
int vx;// bien van toc x
int vy;// bien van toc y
int speed=50;// bien toc do
enum state{
	MENU = 0, INGAME, SETTING, GUIDING, INFORMATION, GAMEOVER
} state;
void menu();
void information();
void setting();
void gameover();
void ingame();
int main(){
	state = MENU;
    menu();
    // vong lap vo han
while(1){
	switch (state){
		case MENU : 
		menu();
		break;
		case INGAME :
			ingame();
			break;
		case GAMEOVER : 
		    gameover();
		    break;
		case INFORMATION :
			information();
			break;
		case  SETTING:
			setting();
			break;
        }
    }
}
// random ngau nhien vi tri moi
int Random(int a, int b){
   return a + rand()%(b-a+1);
}
// ham toa do tham khao code blogger tran han huy
void gotoxy(int x, int y){
    static HANDLE  h = NULL;
    if(!h)
        h = GetStdHandle(STD_OUTPUT_HANDLE);
    COORD c = {x,y};
    SetConsoleCursorPosition(h,c);
}
// ham mau tham khao code blogger tran han huy
void SetColor(WORD color){ 
    HANDLE hConsoleOutput;
    hConsoleOutput = GetStdHandle(STD_OUTPUT_HANDLE);
    CONSOLE_SCREEN_BUFFER_INFO screen_buffer_info;
    GetConsoleScreenBufferInfo(hConsoleOutput, &screen_buffer_info);
    WORD wAttributes = screen_buffer_info.wAttributes;
    color &= 0x000f;
    wAttributes &= 0xfff0; wAttributes |= color;
    SetConsoleTextAttribute(hConsoleOutput, wAttributes);
}
// thong tin chuong trinh
void information(){
	system("cls");
	SetColor(4);
	gotoxy(10,8);
	printf("Moi gop y vui long gui ve hom thu mail:anhtrankoc@gmail.com");
	gotoxy(8,9);
	printf("hoac lien he zalo:0354855613");
	gotoxy(3,10);
	printf("Chuc ae choi game vui ve, an phim enter de tro lai menu");
	gotoxy(27,11);
	SetColor(14);
	printf("----Team_1----");
	getchar();
	state = MENU;
}
// cai dat toc do cho con ran
void setting(){
	system("cls");
	gotoxy(0,9);
	printf("An cac phim up down tren ban phim de tang giam toc do, nhan enter de tro ve menu");
	gotoxy(30,11);
	printf("toc do hien tai : %d",speed);
	int key;
	while(state==SETTING){
        if(kbhit()){
  		    key = getch();
  		    switch (key){
  			    //NOTE: nut trai
  			    case 75 :
  				    if(speed>1){			  
  				        speed -=1;
  				        gotoxy(30,11);
                        printf("toc do hien tai : %d",speed);
                     }
  				    break;
  			    //NOTE: nut phai
  			    case  77 :
  				    if(speed<100){	  
  				        speed+=1;
  					    gotoxy(30,11);
                        printf("toc do hien tai : %d",speed);
                    }
  				    break;
  			    case 13 :
  				    state = MENU;
  				    break;
		    }
	    }
    }	
}
//khung cua tro choi
void vekhung(){
    for(int i=0;i<79;i++){
		printf("=");
	}
	printf("\n");    
    for(int i=0;i<23;i++){	
	    for(int j=0;j<79;j++){
	        if(j==0)
		    printf("=");
	        else if(j==78) 
		    printf("=\n");
	        else 
		    printf(" ");
	    }
    } 
    for(int i=0;i<79;i++){
		printf("=");
	}
}
// ham in ra diem khi nguoi choi ket thuc tro choi
void gameover(){	
    SetColor(48);
    system("cls");
	gotoxy(30,9);
	printf("....Game over....");
	gotoxy(15,11);
	printf("Choi ngu duoc co %d diem, an phim bat ki de ve menu",score);
	gotoxy(27,13);
	printf("|---- Tran_Anh ----|");
	getchar();
	state = MENU;	
}
// ham menu hien ngoai chuong trinh de bat dau tro choi
void menu(){
	SetColor(113);
	system("cls");
    gotoxy(25,3);
	printf("Game ran an moi");
	gotoxy(30,5);
	SetColor(203);
	printf("1.Bat Dau");
	gotoxy(30,6);
	printf("2.Cai Dat ");
	gotoxy(30,7);
	printf("3.Thong Tin");
	int choice = 1;
	int oldChoice = 1;
	int next = 1;
	int key;
	SetColor(14);
	gotoxy(29,5);
	printf("%c",16);
	while(state==MENU){
		if(kbhit()){
			key = getch();	    
			if(key==80) {
			    choice++;
	            if(choice ==4) choice = 1;
			}
			if(key==72) {
			    choice --;
			    if(choice == 0) choice = 3;
			}
		    switch (choice) {
		     	case 1 :
				    if(oldChoice!=choice){
				        gotoxy(29,6);
				        printf(" ");
			         	gotoxy(29,7);
			          	printf(" ");
				        oldChoice = 1;
				        gotoxy(29,5);
				        SetColor(14);
				        printf("%c",16);
				    }
				    break;
			    case 2 :
				    if(oldChoice!=choice){
				        gotoxy(29,5);
				        printf(" ");
				        gotoxy(29,7);
				        printf(" ");
		                gotoxy(29,6);
		                SetColor(14);
				        printf("%c",16);
				        oldChoice = 2;
				    }
				    break;
			    case 3 :
				    if(oldChoice!=choice){
				        gotoxy(29,6);
				        printf(" ");
				        gotoxy(29,5);
				        printf(" ");
				        gotoxy(29,7);
				        SetColor(14);
				        printf("%c",16);	
				        oldChoice = 3;
				    }
				    break;
		    }
		    if(key==13){
		        switch (choice){
		            case 1:			
			            state = INGAME;
			            break;
			        case 2:
				        state = SETTING;
				        break;
			        case 3 :
				        state = INFORMATION;
				        break;
	            }
		    }
	    }
	}
}
// ham khoi tao gia tri ban dau
void initgame(){
	system("cls");
	s_e = 120-speed;
	t = 0;
	vx = 1;
	vy = 0;
	score = 0;
	length = 10;
	character[0] = 11510;
	character[1] = 11410;
	character[2] = 11310;
	character[3] = 11210;
	character[4] = 11110;
	character[5] = 11010;
	character[6] = 10910;
	character[7] = 10810;
	character[8] = 10710;
	character[9] = 10610;
	fruit = 15010;
}
//ham tao moi o vi tri ngau nhien
void creatfruit(){
	int notok = 1;
	while(notok){
		notok = 0;
		fruit = 10000 + Random(1,77)*100 + Random(1,23);
		for(int i=0;i<length;i++){
			//tranh vi tri moi random trung vao vi tri con ran
		    if(character[i]	== fruit){
			    notok = 1;
		    }
		}
	}
}
//ham chuyen toa do 2so ve 1so
int getx(int a){
	return (a-10000)/100;
}
int gety(int a){
	return a%100;
}
//bang thanh tich nguoi choi
void drawscore(){
	gotoxy(79,3);
 	printf("s");
 	gotoxy(79,4);
 	printf("c");
 	gotoxy(79,5);
 	printf("o");
 	gotoxy(79,6);
 	printf("r");
 	gotoxy(79,7);
 	printf("e");
 	gotoxy(79,9); 
 	printf("0");
 	gotoxy(79,10); 
 	printf("0");
 	gotoxy(79,11);
 	printf("0");
 	gotoxy(79,12); 
 	printf("0");
 	gotoxy(79,13);
 	printf("0");
}
//ham cong diem khi an moi
void addscore(){
	SetColor(14);
	gotoxy(79,9); 
	printf("%d",(score%100000)/10000);
 	gotoxy(79,10);
 	printf("%d",(score%10000)/1000);
 	gotoxy(79,11);
 	printf("%d",(score%1000)/100);
 	gotoxy(79,12);
 	printf("%d",(score%100)/10);
 	gotoxy(79,13);
 	printf("%d",score%10);
}
void ingame(){
	int key;
	initgame();
 	vekhung();	
 	drawscore();
 	state = INGAME;
 	SetColor(13);
 	//cau lenh khoi tao vi tri moi con ran
 	gotoxy(getx(fruit),gety(fruit));
 	printf("O");
 	SetColor(12);
 	//cau lenh khoi tao vi tri dau la dau con ran 
 	gotoxy(getx(character[0]),gety(character[0]));
	printf("F");
	SetColor(2);
	//duoi con ran (o) 
 	for(int i=1;i<length;i++){
		gotoxy(getx(character[i]),gety(character[i]));
		printf("o");
	}
	//state dieu khien man hinh con ran
	while(state == INGAME){
		//ham kbhit() tra ve gia tri true khi =1 cÃ²n 0 la k tra ve gia tri nao ca
	    if(kbhit()){
			key = getch();// kiem tra phim
			// dieu khien con ran
			switch (key) {
				//nut len
				case 72:
					if(vy == 0){
						vx = 0;
						vy = -1;
					}
					break;
					//nut xuong
				case 80:
					if(vy == 0){
						vx = 0;
						vy = 1;
					}
					break;
					//nut trai
				case 75:
					if(vx == 0){
						vy = 0;
						vx = -1;
					}
					break;
					// nut phai
				case 77:
					if(vx == 0){
						vy = 0;
						vx = 1;
					}
					break;		
			}						     
	    }
		// cau lenh tang chieu dai con ran khi an moi	
	    if((clock()-t)>=s_e){
	    	//xoa duoi con ran o vi tri cu
		    if(character[length-1]!=0){			
			    gotoxy(getx(character[length-1]),gety(character[length-1]));
			    printf(" ");
		    }
		    for(int i=length-1;i>0;i--){
			    character[i]=character[i-1];
			}
		    SetColor(2);
		    gotoxy(getx(character[0]),gety(character[0]));
		    printf("o");
		    character[0] += vx*100;
		    character[0] += vy;	
		    if(character[0] == fruit){
		        length+= 1;//tang chieu dai khi an moi
		        score += (speed/10 + 5);// tang diem khi an moi
		        addscore();
		        creatfruit();
		        SetColor(13);
		        gotoxy(getx(fruit),gety(fruit));
 	            printf("O");
		    }
		    //khi con ran chay cham khung trai thi xuat hien o khung phai
		    if((vx>0)&&(getx(character[0])==78)){
			    character[0]-=7700;
		    } 
			//khi con ran chay cham khung phai thi xuat hien o khung trai   
		    if((vx<0)&&(getx(character[0])==0)){
			    character[0]+=7700;
		    }
			//khi con ran xuong duoi cham khung thi xuat hien o khung tren  
		    if((vy>0)&&(gety(character[0])==24)){
			    character[0]-=23;
		    }
			//khi con ran di len cham khung thi xuat hien o khung duoi   
		    if((vy<0)&&(gety(character[0])==0)){
			    character[0]+=23;
		    }   
		    SetColor(12);
		    gotoxy(getx(character[0]),gety(character[0]));
		    printf("F");
		    // khi dieu khien dau con ran cham vao  than ran la ran die
		    for(int i=1;i<length;i++){
			    if(character[i]==character[0]){
				    system("cls");					
				    state = GAMEOVER;
			    }
		    }  
		    t = clock();  		    
	    }	
	}	
}
